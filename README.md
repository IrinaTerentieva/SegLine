# üåø SegLine: Geospatial Segmentation Pipeline

**SegLine** is a component of a reproducible pipeline for geospatial analysis of recovery across linear disturbances, including seismic lines and oil and gas exploration corridors. This tool is specifically designed to segment the footprint of linear disturbances into plots and subplots‚Äîunits used for attribute extraction and for building decision trees to assess recovery status.

The pipeline is implemented in **Python** and uses tools such as **GeoPandas**, **Shapely**, and **Hydra** for efficient geospatial processing and flexible configuration management. It supports **parallel execution** and **modular design**, making it adaptable to a variety of geographic datasets.

SegLine represents the **second step** in the broader workflow for assessing recovery on linear disturbances. The **first step** involves the [Forest Line Mapper (FLM)](https://github.com/appliedgrg/flm), a set of scripts used to delineate the linear footprint from coarse or inaccurate prior layers. These source layers vary by jurisdiction‚Äîfor instance, Alberta relies on the Human Footprint Inventory (AMBI), while British Columbia uses the SLU dataset.

SegLine requires fixed-width **footprint** and **centerline** layers, typically generated by FLM. Its output includes the footprint segmented into **plots** (typically 100 m¬≤) and **subplots** (typically 10 m¬≤), with consistent and unique IDs assigned to each geometry, plot, and subplot.

A subsequent module for **attribute extraction** (e.g., vegetation cover, seedling density, trail presence) is under development and will be released soon.

SegLine was developed by the [Applied Geospatial Research Group](https://www.appliedgrg.ca/) at the University of Calgary, led by Dr. Greg McDermid, in collaboration with [Falcon & Swift Geomatics Ltd](https://www.falconandswift.ca/), an environmental consulting company supporting the planning and monitoring of recovery initiatives across Western Canada.

---

## üöÄ Usage

Run the full pipeline using:

```bash
python run_segmentation.py
```

## ‚úÖ Dependencies

Install required packages using:
```bash
pip install -r requirements.txt
```

## üß© Pipeline Steps

The full segmentation pipeline consists of the following five steps:

1. **Assign Unique IDs**  
   Assigns a consistent `UniqueID` to each footprint polygon and links it with the corresponding centerline by interpolating sample points along the centerline.

![Footprint + Centerline](docs/examples/1_line_footprint.png)

2. **Smooth Centerlines** *(Optional)*  
   Reduces sharp angles in the centerlines using buffer-based smoothing to improve the quality of later segmentation.

![Smoothed Centerline](docs/examples/2_smooth_centerline.png)

3. **Split to Plots**  
   Uses the centerline (original or smoothed) to split each polygon into two sides and segments the geometry into **plots** of a specified target area (e.g., 100 m¬≤).

![Segmenting to Plots](docs/examples/3_plots.png)

4. **Split to Sides**  
   Identifies side pairs in each plot (based on orientation and shared edge points), and assigns side labels and `segment_id`.

![Defining Sides and Plots](docs/examples/4_sides.png)

5. **Split to Subplots**  
   Each side is further split into equal-area **subplots** (e.g., 10 m¬≤), and each is assigned a `subplot_id` for fine-scale analysis.

![Segmenting to Subplots](docs/examples/5_subplots.png)

---
## ‚öôÔ∏è Configuration (YAML)

The pipeline is controlled via Hydra configuration in workflow.yaml
dataset:
  ground_footprint: /path/to/footprint.gpkg          Output from FLM
  ground_footprint_layer: null                       Optional if GPKG has multiple layers
  centerline: /path/to/centerline.gpkg               Output from FLM
  centerline_layer: null                             Optional
  debug: false
  unique_id_length: 8

smoothening:
  use_assign_id_output: true
  centerline: null                                   Override if not using assign_id output
  angle_threshold: 120                               Lower = more aggressive smoothing
  buffer_distance: 2
  num_workers: 8

split_to_plots:
  segment_area: 100                                  Target area per plot (m¬≤)
  max_splitter_length_buffer: 30                     Prevents over-splitting curves
  extension_distance: 50                             Extend centerline ends before splitting
  use_smooth_centerline: true
  num_workers: 8

split_to_side:
  segment_area: 100                                  Should match plot area
  min_area: 5                                        Ignore tiny fragments

split_to_subplots:
  segment_area: 10                                   Default subplot area (m¬≤)
  extension_distance: 50
  max_splitter_length_buffer: 15
  num_workers: 8

## ü§ù Acknowledgments

Developed by:

    Applied Geospatial Research Group, University of Calgary
         https://www.appliedgrg.ca/

    Falcon & Swift Geomatics Ltd
      https://www.falconandswift.ca/